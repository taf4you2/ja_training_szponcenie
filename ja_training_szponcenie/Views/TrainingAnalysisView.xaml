<UserControl x:Class="ja_training_szponcenie.Views.TrainingAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:ja_training_szponcenie.Views"
             xmlns:vm="clr-namespace:ja_training_szponcenie.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="{StaticResource BackgroundColor}">

    <UserControl.DataContext>
        <vm:TrainingAnalysisViewModel/>
    </UserControl.DataContext>

    <ScrollViewer>
        <StackPanel Margin="0">

            <!-- HEADER SECTION -->
            <Border Background="White" Padding="16" BorderBrush="{StaticResource DividerColor}" BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Back button and title -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <Button Style="{StaticResource IconButtonStyle}" Command="{Binding GoBackCommand}" Content="â†" FontSize="20"/>
                        <TextBlock Text="{Binding HeaderTitle}" Style="{StaticResource HeaderTextStyle}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                    </StackPanel>

                    <!-- Center: File info -->
                    <StackPanel Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" FontSize="16" HorizontalAlignment="Center"/>
                        <TextBlock Text="{Binding DateTimeText}" Style="{StaticResource CaptionTextStyle}" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                    </StackPanel>

                    <!-- Right: Action buttons -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button Style="{StaticResource IconButtonStyle}" Command="{Binding ExportCommand}" Content="â†—" ToolTip="Eksport"/>
                        <Button Style="{StaticResource IconButtonStyle}" Command="{Binding SettingsCommand}" Content="âš™" ToolTip="Ustawienia wykresu" Margin="4,0,0,0"/>
                        <Button Style="{StaticResource IconButtonStyle}" Content="â‹®" ToolTip="WiÄ™cej opcji" Margin="4,0,0,0"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- MAIN METRICS SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,16,16,8">
                <StackPanel>
                    <!-- Main 8 metrics -->
                    <ItemsControl ItemsSource="{Binding MainMetrics}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="1" Columns="8"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource MetricCardStyle}">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding BackgroundColor}"/>
                                    </Border.Background>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Icon}" FontSize="24" Margin="0,0,0,8" HorizontalAlignment="Left"/>
                                        <TextBlock Text="{Binding Title}" Style="{StaticResource MetricTitleStyle}" Margin="0,0,0,8"/>
                                        <TextBlock Text="{Binding Value}" Style="{StaticResource MetricValueStyle}"/>
                                        <TextBlock Text="{Binding SubValue}" Style="{StaticResource MetricSubValueStyle}" Visibility="{Binding SubValue, Converter={StaticResource NullToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Expand/Collapse button for additional metrics -->
                    <Button Content="PokaÅ¼ wiÄ™cej metryk â–¼"
                            Style="{StaticResource BaseButtonStyle}"
                            Background="Transparent"
                            Foreground="{StaticResource PrimaryColor}"
                            HorizontalAlignment="Center"
                            Margin="0,16,0,0"
                            Command="{Binding ToggleMoreMetricsCommand}"/>

                    <!-- Additional metrics (collapsed by default) -->
                    <ItemsControl ItemsSource="{Binding AdditionalMetrics}" Margin="0,16,0,0">
                        <ItemsControl.Style>
                            <Style TargetType="ItemsControl">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ShowMoreMetrics}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ItemsControl.Style>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="1" Columns="6"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource MetricCardStyle}">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding BackgroundColor}"/>
                                    </Border.Background>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Title}" Style="{StaticResource MetricTitleStyle}" Margin="0,0,0,4"/>
                                        <TextBlock Text="{Binding Value}" FontSize="18" FontWeight="SemiBold"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- CONTEXT SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8" DataContext="{Binding TrainingData.Context}">
                <StackPanel>
                    <TextBlock Text="ðŸ“Š Kontekst tego treningu" Style="{StaticResource SubheaderTextStyle}" Margin="0,0,0,12"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Sleep -->
                        <Border Grid.Column="0" Style="{StaticResource MetricCardStyle}" Background="#E8F5E9">
                            <StackPanel>
                                <TextBlock Text="ðŸ˜´" FontSize="24" Margin="0,0,0,4"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,0,0,2">
                                    <Run Text="{Binding SleepDuration.Hours, Mode=OneWay}"/>
                                    <Run Text="h "/>
                                    <Run Text="{Binding SleepDuration.Minutes, Mode=OneWay}"/>
                                    <Run Text="min"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource CaptionTextStyle}">
                                    <Run Text="Sleep score: "/>
                                    <Run Text="{Binding SleepScore, Mode=OneWay}"/>
                                    <Run Text="/100"/>
                                </TextBlock>
                                <TextBlock Text="{Binding SleepQuality}" FontSize="12" FontWeight="Medium" Foreground="Green" Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- HRV -->
                        <Border Grid.Column="1" Style="{StaticResource MetricCardStyle}" Background="#E3F2FD">
                            <StackPanel>
                                <TextBlock Text="â¤ï¸" FontSize="24" Margin="0,0,0,4"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,0,0,2">
                                    <Run Text="{Binding HRV, Mode=OneWay}"/>
                                    <Run Text="ms"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource CaptionTextStyle}">
                                    <Run Text="{Binding HRVDifference, StringFormat='+{0}ms', Mode=OneWay}"/>
                                    <Run Text=" vs baseline"/>
                                </TextBlock>
                                <TextBlock Text="{Binding RecoveryStatus}" FontSize="12" FontWeight="Medium" Foreground="Green" Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Calories -->
                        <Border Grid.Column="2" Style="{StaticResource MetricCardStyle}" Background="#FFF3E0">
                            <StackPanel>
                                <TextBlock Text="ðŸ½ï¸" FontSize="24" Margin="0,0,0,4"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,0,0,2">
                                    <Run Text="{Binding CaloriesBeforeTraining, Mode=OneWay}"/>
                                    <Run Text=" kcal"/>
                                </TextBlock>
                                <TextBlock Text="SpoÅ¼yte do godziny treningu" Style="{StaticResource CaptionTextStyle}" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- TSB (Form) -->
                        <Border Grid.Column="3" Style="{StaticResource MetricCardStyle}" Background="#E8F5E9">
                            <StackPanel>
                                <TextBlock Text="ðŸ’ª" FontSize="24" Margin="0,0,0,4"/>
                                <TextBlock FontSize="20" FontWeight="SemiBold" Margin="0,0,0,2">
                                    <Run Text="+"/>
                                    <Run Text="{Binding TSB, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Style="{StaticResource CaptionTextStyle}">TSB (Forma)</TextBlock>
                                <TextBlock Text="{Binding FormStatus}" FontSize="12" FontWeight="Medium" Foreground="Green" Margin="0,2,0,0"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- Overall assessment badge -->
                    <Border Background="#C8E6C9" CornerRadius="4" Padding="12,6" HorizontalAlignment="Center" Margin="0,16,0,0">
                        <TextBlock Text="{Binding AssessmentText}" FontWeight="SemiBold" Foreground="#2E7D32"/>
                    </Border>
                </StackPanel>
            </Border>

            <!-- POWER CHART PLACEHOLDER -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8">
                <StackPanel>
                    <Grid Margin="0,0,0,12">
                        <TextBlock Text="Moc w czasie" Style="{StaticResource SubheaderTextStyle}" HorizontalAlignment="Left"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Style="{StaticResource IconButtonStyle}" Content="ðŸ”" ToolTip="Zoom in"/>
                            <Button Style="{StaticResource IconButtonStyle}" Content="ðŸ”„" ToolTip="Reset" Margin="4,0,0,0"/>
                            <Button Style="{StaticResource IconButtonStyle}" Content="âš™" ToolTip="Ustawienia" Margin="4,0,0,0"/>
                        </StackPanel>
                    </Grid>

                    <!-- Chart placeholder -->
                    <Border Background="#F5F5F5" Height="300" CornerRadius="4" BorderBrush="{StaticResource DividerColor}" BorderThickness="1">
                        <TextBlock Text="Wykres mocy (wymaga biblioteki wykresÃ³w)"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Style="{StaticResource CaptionTextStyle}"/>
                    </Border>
                </StackPanel>
            </Border>

            <!-- DETECTED INTERVALS SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8">
                <StackPanel>
                    <Grid Margin="0,0,0,12">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="ðŸ”¥ Wykryte interwaÅ‚y treningowe" Style="{StaticResource SubheaderTextStyle}"/>
                            <TextBlock Style="{StaticResource CaptionTextStyle}" VerticalAlignment="Center" Margin="12,0,0,0">
                                <Run Text="{Binding TrainingData.Intervals.Count, Mode=OneWay}"/>
                                <Run Text=" interwaÅ‚Ã³w"/>
                            </TextBlock>
                        </StackPanel>
                    </Grid>

                    <!-- Intervals DataGrid -->
                    <DataGrid ItemsSource="{Binding TrainingData.Intervals}"
                              Style="{StaticResource IntervalDataGridStyle}"
                              MaxHeight="400">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Number}" Width="40"/>
                            <DataGridTextColumn Header="Czas" Width="120">
                                <DataGridTextColumn.Binding>
                                    <MultiBinding StringFormat="{}{0:hh\:mm\:ss} - {1:hh\:mm\:ss}">
                                        <Binding Path="StartTime"/>
                                        <Binding Path="EndTime"/>
                                    </MultiBinding>
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Czas trwania" Binding="{Binding Duration, StringFormat='{}{0:mm\\:ss}'}" Width="100"/>
                            <DataGridTextColumn Header="Åšrednia moc" Width="110">
                                <DataGridTextColumn.Binding>
                                    <MultiBinding StringFormat="{}{0:F0} W ({1:F0}%)">
                                        <Binding Path="AveragePower"/>
                                        <Binding Path="PercentageFTP"/>
                                    </MultiBinding>
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Strefa" Binding="{Binding ZoneName}" Width="120"/>
                            <DataGridTextColumn Header="NP" Binding="{Binding NormalizedPower, StringFormat='{}{0:F0} W'}" Width="80"/>
                            <DataGridTextColumn Header="Typ" Binding="{Binding Type}" Width="80"/>
                            <DataGridTextColumn Header="TÄ™tno" Binding="{Binding AverageHeartRate, StringFormat='{}{0} bpm'}" Width="90"/>
                            <DataGridTextColumn Header="Kadencja" Binding="{Binding AverageCadence, StringFormat='{}{0} rpm'}" Width="90"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Interval statistics -->
                    <Border Background="#F5F5F5" CornerRadius="4" Padding="12" Margin="0,12,0,0">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Style="{StaticResource CaptionTextStyle}" Margin="0,0,24,0">
                                <Run Text="CaÅ‚kowity czas w interwaÅ‚ach: "/>
                                <Run Text="18:42" FontWeight="SemiBold"/>
                            </TextBlock>
                            <TextBlock Style="{StaticResource CaptionTextStyle}" Margin="0,0,24,0">
                                <Run Text="Åšrednia moc interwaÅ‚Ã³w: "/>
                                <Run Text="315 W" FontWeight="SemiBold"/>
                            </TextBlock>
                            <TextBlock Style="{StaticResource CaptionTextStyle}">
                                <Run Text="NajdÅ‚uÅ¼szy interwaÅ‚: "/>
                                <Run Text="5:45" FontWeight="SemiBold"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- TIME IN ZONES SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Chart placeholder -->
                    <StackPanel Grid.Column="0" Margin="0,0,16,0">
                        <TextBlock Text="ðŸ“Š Czas w strefach mocy" Style="{StaticResource SubheaderTextStyle}" Margin="0,0,0,12"/>
                        <Border Background="#F5F5F5" Height="250" CornerRadius="4" BorderBrush="{StaticResource DividerColor}" BorderThickness="1">
                            <TextBlock Text="Wykres koÅ‚owy/sÅ‚upkowy"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Style="{StaticResource CaptionTextStyle}"/>
                        </Border>
                    </StackPanel>

                    <!-- Zones table -->
                    <DataGrid Grid.Column="1"
                              ItemsSource="{Binding TrainingData.PowerZones}"
                              Style="{StaticResource IntervalDataGridStyle}"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Strefa" Width="80">
                                <DataGridTextColumn.Binding>
                                    <MultiBinding StringFormat="{}{0}: {1}">
                                        <Binding Path="ZoneName"/>
                                        <Binding Path="ZoneDescription"/>
                                    </MultiBinding>
                                </DataGridTextColumn.Binding>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Zakres mocy" Binding="{Binding RangeText}" Width="180"/>
                            <DataGridTextColumn Header="Czas" Binding="{Binding TimeText}" Width="80"/>
                            <DataGridTextColumn Header="%" Binding="{Binding Percentage, StringFormat='{}{0}%'}" Width="60"/>
                            <DataGridTextColumn Header="Åšrednia moc" Binding="{Binding AverageValue, StringFormat='{}{0:F0} W'}" Width="110"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>

            <!-- POWER CURVE SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8">
                <StackPanel>
                    <TextBlock Text="ðŸ’ª Power Curve - Najlepsze wyniki" Style="{StaticResource SubheaderTextStyle}" Margin="0,0,0,4"/>
                    <TextBlock Text="Maksymalna Å›rednia moc dla rÃ³Å¼nych czasÃ³w trwania" Style="{StaticResource CaptionTextStyle}" Margin="0,0,0,12"/>

                    <!-- Chart placeholder -->
                    <Border Background="#F5F5F5" Height="200" CornerRadius="4" BorderBrush="{StaticResource DividerColor}" BorderThickness="1" Margin="0,0,0,12">
                        <TextBlock Text="Wykres Power Curve"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Style="{StaticResource CaptionTextStyle}"/>
                    </Border>

                    <!-- Power curve table -->
                    <DataGrid ItemsSource="{Binding TrainingData.PowerCurve}"
                              Style="{StaticResource IntervalDataGridStyle}"
                              MaxHeight="300">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Czas" Binding="{Binding DurationText}" Width="80"/>
                            <DataGridTextColumn Header="Moc" Binding="{Binding Power, StringFormat='{}{0:F0} W'}" Width="100"/>
                            <DataGridTextColumn Header="W/kg" Binding="{Binding WattsPerKg, StringFormat='{}{0:F1}'}" Width="80"/>
                            <DataGridTextColumn Header="% FTP" Binding="{Binding PercentageFTP, StringFormat='{}{0:F0}%'}" Width="80"/>
                            <DataGridTextColumn Header="OsiÄ…gniÄ™te o" Binding="{Binding TimeAchieved, StringFormat='{}{0:mm\\:ss}'}" Width="100"/>
                            <DataGridTemplateColumn Header="Rekord" Width="250">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value=""/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsPersonalRecord}" Value="True">
                                                            <Setter Property="Text">
                                                                <Setter.Value>
                                                                    <MultiBinding StringFormat="ðŸ†• NOWY REKORD! (poprz: {0:F0} W)">
                                                                        <Binding Path="PreviousRecord"/>
                                                                    </MultiBinding>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="Foreground" Value="Green"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </Border>

            <!-- NOTES SECTION -->
            <Border Style="{StaticResource CardStyle}" Margin="16,8,16,16">
                <StackPanel>
                    <TextBlock Text="ðŸ“ Notatki" Style="{StaticResource SubheaderTextStyle}" Margin="0,0,0,12"/>

                    <TextBox Text="{Binding TrainingData.Notes, UpdateSourceTrigger=PropertyChanged}"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             MinHeight="100"
                             MaxHeight="200"
                             VerticalScrollBarVisibility="Auto"
                             Padding="8"
                             BorderBrush="{StaticResource DividerColor}"
                             BorderThickness="1"
                             FontFamily="{StaticResource PrimaryFont}"
                             FontSize="14">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Background" Value="White"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                                    </Trigger>
                                    <Trigger Property="IsFocused" Value="True">
                                        <Setter Property="BorderBrush" Value="{StaticResource PrimaryColor}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>

                    <TextBlock Style="{StaticResource CaptionTextStyle}" Margin="0,4,0,0">
                        <Run Text="Dodaj notatki o tym treningu: odczucia, warunki pogodowe, komentarze..."/>
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>
